"use strict";function Vertex(){this.x=0,this.y=0,this.label="",this.type="",this.agent=0,this.agentMax=10,this.debit=0}function Edge(){this.vOut=null,this.vIn=null,this.weight=100,this.type=""}function Graph(){this.adjList={},this.vertices=[],this.gen_vertices=[],this.matrix=null}Graph.prototype.addVertex=function(t,r){r=void 0===r?1:r;var i=new Vertex;return i.label=t,this.vertices.push(i),this.adjList[i.label]={v:i,out:[],outs:{}},i},Graph.prototype.getVertex=function(t){return this.adjList[t].v},Graph.prototype.addEdge=function(t,r,i){i=void 0===i?100:i;var a=new Edge;a.vOut=this.adjList[t].v,a.vIn=this.adjList[r].v,a.weight=i,this.adjList[t].out.push(a),this.adjList[t].outs[r]=a},Graph.prototype.neighbors=function(t){return Object.keys(this.adjList[t])},Graph.prototype.getEdge=function(t,r){return this.adjList[t][r]},Graph.prototype.vecteurAgent=function(){for(var t=new Matrix(1,this.vertices.length),r=0;r<this.vertices.length;r++)t.array[0][r]=this.vertices[r].agent;return t},Graph.prototype.initVecteurAgent=function(){var t,r=new Matrix(1,this.vertices.length),i=r.array[0].length;for(t=0;i>t;t++)r.array[0][t]=1/i;return r},Graph.prototype.toMatrix=function(){var t,r,i,a=this.vertices.length,e=new GraphMatrix(a);for(t in this.adjList)for(r=0;r<this.adjList[t].out.length;r++)i=this.adjList[t].out[r],e.addEdge(this.vertices.indexOf(i.vOut),this.vertices.indexOf(i.vIn),i.weight);return e},Graph.prototype.theUglyLinkManager=function(t){this.matrix.matrix.normalize();var r,i,a,e;for(i=0;i<this.matrix.size;i++)if(e=this.vertices[i].agentMax-this.vertices[i].agent,0>=e)for(r=0;r<this.matrix.size;r++)this.matrix.matrix.array[r][i]>0&&(this.matrix.matrix.array[r][i]=0);else if(e>0)for(r=0;r<this.matrix.size;r++)this.matrix.matrix.array[r][i]>0&&(a=t.array[0][r]*this.matrix.matrix.array[r][i],e>a?(this.matrix.matrix.array[r][i]=a,e-=a):a>=e&&(0==e?this.matrix.matrix.array[r][i]=0:(this.matrix.matrix.array[r][i]=e,e=0)))},Graph.prototype.theUglyPipeManager=function(t){var r,i,a,e;for(r=0;r<t.array[0].length;r++){for(a=0,e=0,i=0;i<this.matrix.array.length;i++)e+=this.matrix.array[r][i];if(a=t.array[0][r]-e,a>0&&0!=e&&(this.matrix.array[r][r]=a),0>a)for(i=0;i<this.matrix.array.length;i++)this.matrix.matrix.array[r][i]>0&&(this.matrix.matrix.array[r][i]=1)}},Graph.prototype.bouclageSommet=function(){var t,r;for(t=0;t<this.vertices.length;t++)r=this.vertices[t],"out"!=r.type&&1==this.matrix.noOutput(t)&&this.matrix.addEdge(t,t,1)},Graph.prototype.deplacementVisiteur=function(){var t,r=this.vecteurAgent(),i=null;this.matrix=this.toMatrix(),this.theUglyLinkManager(r),this.bouclageSommet();for(var a=0;a<r.array[0].length;a++)r.array[0][a]<0&&console.log("ca");this.theUglyPipeManager(r),this.matrix.matrix.normalize();for(var e={},s=0;s<this.matrix.array.length;s++)for(var h=0;h<this.matrix.array[s].length;h++)this.matrix.array[s][h]>0&&s!=h&&(e[s+":"+h]=r.array[0][s]*this.matrix.array[s][h],this.adjList[this.vertices[s].label].outs[this.vertices[h].label].past=e[s+":"+h]);for(i=r.dot(this.matrix.matrix),t=0;t<this.vertices.length;t++)this.vertices[t].agent=Math.max(0,i.array[0][t]);return e};
"use strict";function GraphMatrix(r){this.size=r,this.matrix=new Matrix(r,r),this.array=this.matrix.array}GraphMatrix.prototype.addEdge=function(r,t,a){a=void 0===a?1:a,this.array[r][t]=a},GraphMatrix.prototype.noOutput=function(r){var t;for(t=0;t<this.array.length;t++)if(this.array[r][t]>0)return!1;return!0};
"use strict";function Matrix(r,a){this.w=r,this.h=a,this.array=[a];for(var t=0;r>t;t++){this.array[t]=[r];for(var h=0;a>h;h++)this.array[t][h]=0}}Matrix.prototype.normalize=function(r,a){var r,a,t=0;for(r=0;r<this.array.length;r++){for(t=0,a=0;a<this.array[r].length;a++)t+=this.array[r][a];if(0!=t)for(a=0;a<this.array[r].length;a++)this.array[r][a]=this.array[r][a]/t}},Matrix.prototype.dot=function(r){var a=0,t=0,h=0,i=new Matrix(this.array.length,r.array[0].length);for(a=0;a<this.array.length;a++)for(h=0;h<r.array[0].length;h++)for(t=0;t<this.array[0].length;t++)i.array[a][h]+=this.array[a][t]*r.array[t][h];return i},Matrix.prototype.scalar=function(r){for(var a=0;a<this.array.length;a++)for(var t=0;t<this.array[0].length;t++)this.array[a][t]*=r},Matrix.prototype.distance=function(r){var a,t=0;for(a=0;a<this.array[0].length;a++)t+=Math.pow(this.array[0][a]-r.array[0][a],2);return Math.sqrt(t)},Matrix.prototype.manhattan=function(r){var a,t=0;for(a=0;a<this.array[0].length;a++)t+=Math.abs(this.array[0][a]-r.array[0][a]);return t};
function render(){renderer.render(scene,camera),window.requestAnimationFrame(render)}function createScene(){var e=4,t=26,r=14;for(var n in g.adjList){var a=g.adjList[n],i=addBrick(a.v.x*e-t,a.v.y*e-r,a.v.type);a.v.brick=i}for(var n in g.adjList)for(var a=g.adjList[n],o=0;o<a.out.length;o++){var s=a.out[o],i=addLine(s.vOut.x*e-t,s.vOut.y*e-r,s.vIn.x*e-t,s.vIn.y*e-r,s);i.lala=s,objects.push(i),s.glo=i}g.adjList[1].v.brick.material=new THREE.MeshPhongMaterial({color:16777215,emissive:16777215}),g.adjList[13].v.brick.material=new THREE.MeshPhongMaterial({color:16777215,emissive:16777215}),g.adjList[26].v.brick.material=new THREE.MeshPhongMaterial({color:5263440,emissive:1184274,specular:5263440}),g.adjList[32].v.brick.material=new THREE.MeshPhongMaterial({color:5263440,emissive:1184274,specular:5263440})}var g,mesh,renderer,scene,camera,controls,projector,objects=[],pressed_edge=null,_agentVector=new Matrix(0,0),ppm,synthAgentIn,synthTouk,synthTa,synthAgentOut,synthAgentNode,msec,material_1=new THREE.MeshBasicMaterial({color:137031,specular:137031,shading:THREE.FlatShading}),material_2=new THREE.MeshPhongMaterial({color:16760745,specular:16760745,emissive:16760745}),material_3=new THREE.MeshLambertMaterial({color:15395302,emissive:15395302}),onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)},onDocumentMouseUp=function(e){if(e.preventDefault(),pressed_edge){var t=pressed_edge.vOut,r=pressed_edge.vIn,n=pressed_edge;t.agentMax=10,r.agentMax=10,n.weight=100,pressed_edge=null}},onDocumentMouseDown=function(e){e.preventDefault();var t=new THREE.Vector3(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1,.5),r=projector.pickingRay(t,camera),n=r.intersectObjects(objects);if(n.length>0){var a=n[0].object.lala.vOut,i=n[0].object.lala.vIn,o=n[0].object.lala;a.agentMax=0,i.agentMax=0,o.weight=0,pressed_edge=o}},init=function(){renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.shadowMapEnabled=!0,renderer.shadowMapSoft=!0,renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement),scene=new THREE.Scene;var e=window.innerWidth/window.innerHeight,t=24;camera=new THREE.OrthographicCamera(-t*e,t*e,t,-t,1,1e3),camera.position.set(20,20,20),camera.lookAt(scene.position),projector=new THREE.Projector;var r=new THREE.PointLight(16777215,.4,0);r.position.set(-80,100,-80),r.rotation.x=Math.PI/2,scene.add(r);var r=new THREE.SpotLight(16777215,.2);r.castShadow=!0,r.position.set(40,0,-50),r.rotation.y=-Math.PI/6,scene.add(r);var r=new THREE.SpotLight(16777215,.5);r.castShadow=!0,r.position.set(-60,10,0),r.rotation.y=Math.PI/2,scene.add(r);var n=new THREE.PlaneGeometry(10,10),a=new THREE.MeshBasicMaterial({color:14540253}),i=new THREE.Mesh(n,a);i.position.x=-30,i.position.y=20,i.position.z=-10,i.rotation.x=-Math.PI/2;var n=new THREE.PlaneGeometry(100,100,10,10),a=new THREE.MeshBasicMaterial({color:14540253,wireframe:!0,opacity:1,transparent:!0}),i=new THREE.Mesh(n,a);i.rotation.order="YXZ",i.rotation.y=-Math.PI/2,i.rotation.x=-Math.PI/2},addLine=function(e,t,r,n,a){var i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(2*e,2*t,0)),i.vertices.push(new THREE.Vector3(2*r,2*n,0));var o=new THREE.LineBasicMaterial({color:137031}),s=new THREE.Line(i,o);s.rotation.x=Math.PI/2;var i=new THREE.PlaneGeometry(2,2),c=new THREE.MeshBasicMaterial({color:137031,side:THREE.DoubleSide}),m=new THREE.Mesh(i,c),y=Math.abs(s.geometry.vertices[1].y-s.geometry.vertices[0].y),v=Math.abs(s.geometry.vertices[1].x-s.geometry.vertices[0].x),g=s.geometry.vertices[1].y-s.geometry.vertices[0].y,l=s.geometry.vertices[1].x-s.geometry.vertices[0].x,d=y/v;return 1/0==d?(m.geometry.vertices[0].x=s.geometry.vertices[0].x-1,m.geometry.vertices[0].y=s.geometry.vertices[0].y,m.geometry.vertices[1].x=s.geometry.vertices[0].x+1,m.geometry.vertices[1].y=s.geometry.vertices[0].y,m.geometry.vertices[2].x=s.geometry.vertices[1].x-1,m.geometry.vertices[2].y=s.geometry.vertices[1].y,m.geometry.vertices[3].x=s.geometry.vertices[1].x+1,m.geometry.vertices[3].y=s.geometry.vertices[1].y,0>g?(a.vOut.brick.material.materials[5]=material_1,a.vIn.brick.material.materials[4]=material_1):(a.vOut.brick.material.materials[4]=material_1,a.vIn.brick.material.materials[5]=material_1)):1==d?(m.geometry.vertices[0].x=s.geometry.vertices[0].x-1,m.geometry.vertices[0].y=s.geometry.vertices[0].y+1,m.geometry.vertices[1].x=s.geometry.vertices[0].x+1,m.geometry.vertices[1].y=s.geometry.vertices[0].y+1,m.geometry.vertices[2].x=s.geometry.vertices[1].x-1,m.geometry.vertices[2].y=s.geometry.vertices[1].y+1,m.geometry.vertices[3].x=s.geometry.vertices[1].x+1,m.geometry.vertices[3].y=s.geometry.vertices[1].y+1,l>0&&0>g?(m.geometry.vertices[0].x=s.geometry.vertices[0].x-1,m.geometry.vertices[0].y=s.geometry.vertices[0].y-1,m.geometry.vertices[1].x=s.geometry.vertices[0].x+1,m.geometry.vertices[1].y=s.geometry.vertices[0].y-1,m.geometry.vertices[2].x=s.geometry.vertices[1].x-1,m.geometry.vertices[2].y=s.geometry.vertices[1].y-1,m.geometry.vertices[3].x=s.geometry.vertices[1].x+1,m.geometry.vertices[3].y=s.geometry.vertices[1].y-1):0>l&&g>0?(m.geometry.vertices[0].x=s.geometry.vertices[0].x-1,m.geometry.vertices[0].y=s.geometry.vertices[0].y-1,m.geometry.vertices[1].x=s.geometry.vertices[0].x-1,m.geometry.vertices[1].y=s.geometry.vertices[0].y+1,m.geometry.vertices[2].x=s.geometry.vertices[1].x-1,m.geometry.vertices[2].y=s.geometry.vertices[1].y-1,m.geometry.vertices[3].x=s.geometry.vertices[1].x+1,m.geometry.vertices[3].y=s.geometry.vertices[1].y-1):l>0&&g>0&&(a.vOut.brick.material.materials[4]=material_1,a.vIn.brick.material.materials[1]=material_1)):0==d&&(m.geometry.vertices[0].x=s.geometry.vertices[0].x,m.geometry.vertices[0].y=s.geometry.vertices[0].y-1,m.geometry.vertices[1].x=s.geometry.vertices[0].x,m.geometry.vertices[1].y=s.geometry.vertices[0].y+1,m.geometry.vertices[2].x=s.geometry.vertices[1].x,m.geometry.vertices[2].y=s.geometry.vertices[1].y-1,m.geometry.vertices[3].x=s.geometry.vertices[1].x,m.geometry.vertices[3].y=s.geometry.vertices[1].y+1,l>0?(a.vOut.brick.material.materials[0]=material_1,a.vIn.brick.material.materials[1]=material_1):(a.vOut.brick.material.materials[1]=material_1,a.vIn.brick.material.materials[0]=material_1)),m.rotation.x=Math.PI/2,m.geometry.computeFaceNormals(),m.geometry.computeVertexNormals(),scene.add(m),m},addBrick=function(e,t){var r=new THREE.BoxGeometry(2,.5,2),n=[material_2,material_2,material_3,material_2,material_2,material_2],a=new THREE.MeshFaceMaterial(n),i=new THREE.Mesh(r,a);return i.position.x=2*e,i.position.z=2*t,i.position.y=.25,scene.add(i),i},addPlane=function(e,t){var r=new THREE.PlaneGeometry(2,2),n=new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide}),a=new THREE.Mesh(r,n);return a.position.x=2*e,a.position.z=2*t,a.rotation.x=Math.PI/2,scene.add(a),a},loadGraph=function(e){$.getJSON("g1.json",function(t){var r,n=new Graph;for(var a in t.graph.nodes){r=t.graph.nodes[a];var a=n.addVertex(a);a.x=r.pos[0],a.y=r.pos[1],a.type=r.type}for(var a in t.graph.nodes){r=t.graph.nodes[a];for(var i=0;i<r.out.length;i++){var o=r.out[i];n.addEdge(a,o)}}n.getVertex("1").agent=10,e(n)})},updateModel=function(){var e=(g.deplacementVisiteur(),0),t=0,r=g.vecteurAgent();r.normalize();var n=r.distance(_agentVector);_agentVector=r;for(var a in g.adjList){for(var i=g.adjList[a],o=0;o<i.out.length;o++){var s=i.out[o].glo;s.material.linewidth=1+5*Math.log(Math.max(1,i.out[o].vOut.agent-i.out[o].vIn.agent));var c=(i.out[o].vOut.agent-i.out[o].vIn.agent,i.out[o].vOut.agent/i.out[o].vOut.agentMax),m=i.out[o].vIn.agent/i.out[o].vIn.agentMax,y=c/m,v=i.out[o],l=[1214062,15296107,14893939,137031,16777215],d=0;0==v.weight?d=4:.25>=y?d=0:.5>=y?d=1:.85>=y?d=2:1>=y&&(d=3),0==v.weight&&s.material.color.setHex(16525393),s.material.color.setHex(l[d]);var u=["#3F3965","#27112C"];document.body.style.backgroundColor=n>.01?u[0]:u[1]}if("in"==i.v.type){var h=i.v.agent;i.v.agent=Math.min(i.v.agentMax,i.v.agent+10),t+=i.v.agent-h}if("out"==i.v.type){var p=Math.max(0,i.v.agent-10);e+=i.v.agent-p,i.v.agent=p}}var f=Math.ceil(e)-Math.ceil(t);if(ppm.sound){if(e>0){var w=Math.ceil(ppm.noteOut+e);synthTouk.noteOn(w,1)}if(t>0){var w=Math.ceil(ppm.noteIn+t);synthTa.noteOn(w,1),synthAgentIn.noteOn(Math.min(72,Math.ceil(50*n+50)),1),synthAgentOut.noteOn(Math.min(72,10+40*f),1)}}};ppm={sound:!0,noteIn:40,noteOut:68,a:1e3},synthTouk=T("SynthDef").play(),synthTouk.def=function(e){var t,r,n,a;return r=T("sin",{freq:e.freq,mul:1}),n=T("sin",{freq:e.freq*Math.pow(1.5,2),mul:.5}),a=T("sin",{freq:e.freq*Math.pow(1.5,4),mul:.2}),t=T("perc",{a:20,r:30},r,n,a),t.on("ended",e.doneAction).bang()},synthTouk.play(),synthTa=T("SynthDef").play(),synthTa.def=function(e){var t,r,n,a,i,o;return r=T("sin",{freq:e.freq,mul:1}),n=T("sin",{freq:1.5*e.freq,mul:.8}),a=T("sin",{freq:e.freq*Math.pow(1.5,2),mul:.6}),i=T("sin",{freq:e.freq*Math.pow(1.5,3),mul:.4}),o=T("sin",{freq:e.freq*Math.pow(1.5,4),mul:.2}),t=T("perc",{a:20,r:50},r,n,a,i,o),t.on("ended",e.doneAction).bang()},synthTa.play(),synthAgentOut=T("SynthDef").play(),synthAgentOut.def=function(e){var t,r,n,a,i,o;return r=T("sin",{freq:e.freq,mul:1}),n=T("sin",{freq:1.5*e.freq,mul:.8}),a=T("sin",{freq:e.freq*Math.pow(1.5,2),mul:.5}),i=T("sin",{freq:e.freq*Math.pow(1.5,3),mul:.4}),o=T("sin",{freq:e.freq*Math.pow(1.5,4),mul:.2}),t=T("perc",{a:500,r:300},r,n,a,i,o),t.on("ended",e.doneAction).bang()},synthAgentOut.play(),synthAgentNode=T("SynthDef").play(),synthAgentNode.def=function(e){var t,r,n,a,i,o,t;return r=T("sin",{freq:e.freq,mul:1}),n=T("sin",{freq:2*e.freq,mul:.5}),a=T("sin",{freq:4*e.freq,mul:.25}),i=T("sin",{freq:5*e.freq,mul:.125}),o=T("sin",{freq:6*e.freq,mul:.0625}),t=T("linen",{a:200,d:50,s:50,r:200},r,n,a,i,o),t.on("ended",e.doneAction).bang()},synthAgentNode.play(),synthAgentIn=T("SynthDef").play(),synthAgentIn.def=function(e){var t,r,n,a,i,t;return r=T("sin",{freq:e.freq,mul:1}),n=T("sin",{freq:2*e.freq,mul:.5}),a=T("sin",{freq:4*e.freq,mul:.25}),i=T("sin",{freq:5*e.freq,mul:.125}),t=T("adsr",{a:5,d:500,s:0,r:1500},r,n,a,i),t.on("ended",e.doneAction).bang()},synthAgentIn.play(),document.addEventListener("mousedown",onDocumentMouseDown,!1),document.addEventListener("mouseup",onDocumentMouseUp,!1),window.addEventListener("resize",onWindowResize,!1),init(),loadGraph(function(e){g=e,createScene(),render(),msec=timbre.timevalue("bpm96 l6"),T("interval",{interval:msec},function(e){updateModel(e)}).start()});